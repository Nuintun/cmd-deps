/**
 * @module cmd-deps
 * @author nuintun
 * @license MIT
 * @version 3.0.0
 * @description Transform cmd and get cmd dependences
 * @see https://nuintun.github.io/cmd-deps
 */
"use strict";const acorn=require("acorn"),toString=Object.prototype.toString;function string(e){return"[object String]"===toString.call(e)}function fn(e){return"[object Function]"===toString.call(e)}function object(e){return"[object Object]"===toString.call(e)}function defined(){const e=arguments,t=e.length;for(let r=0;r<t;r++){const t=e[r];if(void 0!==t)return t}}function encode(e){return e.replace(/['"]/g,"\\$&")}function parse(e,t){return t=t||{},acorn.parse(e,{sourceType:t.sourceType,ranges:defined(t.ranges,!1),locations:defined(t.locations,null),ecmaVersion:defined(t.ecmaVersion,6),allowHashBang:defined(t.allowHashBang,!0),allowReserved:defined(t.allowReserved,!0),allowReturnOutsideFunction:defined(t.allowReturnOutsideFunction,!0),allowImportExportEverywhere:defined(t.allowImportExportEverywhere,!0)})}function traverse(e,t){if(!1!==t.call(null,e))for(let r in e)if(e.hasOwnProperty(r)){let n=e[r];null!==n&&"object"==typeof n&&traverse(n,t)}}function visit(e,t,r){let n;try{n=parse(e,t)}catch(e){}n&&traverse(n,r)}function isRequire(e,t,r){if("CallExpression"===e.type)return e=e.callee,r.length&&"MemberExpression"===e.type?"Identifier"===e.object.type&&e.object.name===t&&("Identifier"===e.property.type&&-1!==r.indexOf(e.property.name)||"Literal"===e.property.type&&-1!==r.indexOf(e.property.value)):"Identifier"===e.type&&e.name===t}function parser(e,t,r){let n=0;const o=[];if(t&&object(t)&&(r=t,t=null),r=r||{},string(e)||(e=""),string(r.word)||(r.word="require"),!new RegExp(`\\b${r.word}\\b`).test(e))return{code:e,dependencies:o};Array.isArray(r.flags)||(r.flags=[]),t&&!fn(t)&&(t=null);const i=(r,i)=>{let l;const s=r.value;o.push({flag:i,path:s}),t&&string(l=t(s,i))&&l.trim()&&(l=encode(l),e=e.substring(0,r.start+n+1)+l+e.substring(r.end+n-1),n+=l.length-s.length)};return visit(e,r.acorn,e=>{if(isRequire(e,r.word,r.flags)){let t=e.arguments;const r=e.callee.property,n=r?r.name:null;t.length&&("Literal"===(t=t[0]).type?i(t,n):"ArrayExpression"===t.type&&t.elements.forEach(e=>{"Literal"===e.type&&i(e,n)}))}}),{code:e,dependencies:o}}module.exports=parser;